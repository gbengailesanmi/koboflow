/** * CENTRALIZED API SERVICE (Server-side only) *  * This file handles ALL backend communication for Server Components. * For Client Components, use api-service-client.ts *  * Features: * - Next.js automatic caching with revalidation tags * - Server-side cookie handling * - Type-safe API responses * - Cache invalidation after mutations *  * ARCHITECTURE: * - Server Components call these functions directly * - Client Components use api-service-client.ts wrapper * - Zustand stores UI state only (no API data) * - Next.js handles all data caching */'use server'import { cookies } from 'next/headers'import { revalidateTag } from 'next/cache'import { redirect } from 'next/navigation'import config from '../config'const BACKEND_URL = config.BACKEND_URL// ============================================================================// TYPES// ============================================================================interface ApiResponse<T = any> {  success: boolean  message?: string  data?: T  [key: string]: any}export interface SessionData {  customerId: string  email: string  firstName?: string  lastName?: string}// ============================================================================// CACHE STRATEGIES// ============================================================================const CACHE = {  // Session data - cache for 5 minutes  SESSION: { next: { revalidate: 300, tags: ['session'] } },    // User settings - cache for 10 minutes  SETTINGS: { next: { revalidate: 600, tags: ['settings'] } },    // Bank accounts - cache for 5 minutes  ACCOUNTS: { next: { revalidate: 300, tags: ['accounts'] } },    // Transactions - cache for 2 minutes (updates frequently)  TRANSACTIONS: { next: { revalidate: 120, tags: ['transactions'] } },    // Budget - cache for 5 minutes  BUDGET: { next: { revalidate: 300, tags: ['budget'] } },    // Categories - cache for 10 minutes (rarely changes)  CATEGORIES: { next: { revalidate: 600, tags: ['categories'] } },    // No cache for mutations and auth  NONE: { cache: 'no-store' as const },} as const// ============================================================================// CORE REQUEST FUNCTION// ============================================================================/** * Makes server-side API requests with authentication * Automatically includes session-id cookie */async function request<T = any>(  endpoint: string,  options: RequestInit = {},  cacheStrategy?: any): Promise<T> {  try {    const cookieStore = await cookies()    const sessionId = cookieStore.get('session-id')?.value    const response = await fetch(`${BACKEND_URL}${endpoint}`, {      ...options,      ...cacheStrategy,      headers: {        'Content-Type': 'application/json',        ...(sessionId && { Cookie: `session-id=${sessionId}` }),        ...options.headers,      },      credentials: 'include',    })    if (!response.ok) {      if (response.status === 401) {        console.warn('[API Service] Unauthorized - session invalid')        redirect('/login')      }            const errorData = await response.json().catch(() => ({}))      throw new Error(errorData.message || `API Error: ${response.status}`)    }    return await response.json()  } catch (error) {    console.error(`[API Service] Request failed [${endpoint}]:`, error)    throw error  }}// ============================================================================// AUTHENTICATION & SESSION// ============================================================================/** * Get current user session * Cached for 5 minutes with 'session' tag */export async function getSession() {  console.log('[API Service] getSession')  return request('/api/session', {}, CACHE.SESSION)}/** * Login with credentials * No caching */export async function login(email: string, password: string) {  console.log('[API Service] login')  const result = await request('/api/auth/login', {    method: 'POST',    body: JSON.stringify({ email, password }),  }, CACHE.NONE)    // Invalidate session cache  revalidateTag('session')    return result}/** * Signup new user * No caching */export async function signup(data: {  firstName: string  lastName: string  email: string  password: string  passwordConfirm: string}) {  console.log('[API Service] signup')  return request('/api/auth/signup', {    method: 'POST',    body: JSON.stringify(data),  }, CACHE.NONE)}/** * Logout current session * No caching */export async function logout() {  console.log('[API Service] logout')  const result = await request('/api/auth/logout', {    method: 'POST',  }, CACHE.NONE)    // Invalidate all caches  revalidateTag('session')  revalidateTag('accounts')  revalidateTag('transactions')  revalidateTag('budget')  revalidateTag('settings')    return result}/** * Logout from all devices * No caching */export async function logoutAll() {  console.log('[API Service] logoutAll')  const result = await request('/api/auth/logout-all', {    method: 'POST',  }, CACHE.NONE)    // Invalidate all caches  revalidateTag('session')  revalidateTag('accounts')  revalidateTag('transactions')  revalidateTag('budget')  revalidateTag('settings')    return result}/** * Get all active sessions for current user * No caching (real-time data) */export async function getSessions() {  console.log('[API Service] getSessions')  return request('/api/auth/sessions', {}, CACHE.NONE)}// ============================================================================// USER & SETTINGS// ============================================================================/** * Get user settings * Cached for 10 minutes with 'settings' tag */export async function getSettings(customerId: string) {  console.log('[API Service] getSettings')  return request(`/api/settings/${customerId}`, {}, CACHE.SETTINGS)}/** * Update user settings * No caching, invalidates settings cache */export async function updateSettings(customerId: string, data: any) {  console.log('[API Service] updateSettings')  const result = await request(`/api/settings/${customerId}`, {    method: 'PATCH',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate settings cache  revalidateTag('settings')    return result}/** * Get user profile * No caching */export async function getUserProfile(customerId: string) {  console.log('[API Service] getUserProfile')  return request(`/api/auth/user/${customerId}`, {}, CACHE.NONE)}/** * Update user profile * No caching */export async function updateUserProfile(customerId: string, data: any) {  console.log('[API Service] updateUserProfile')  const result = await request(`/api/auth/user/${customerId}`, {    method: 'PATCH',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate session cache (user data changed)  revalidateTag('session')    return result}// ============================================================================// ACCOUNTS// ============================================================================/** * Get all accounts for a user * Cached for 5 minutes with 'accounts' tag */export async function getAccounts(customerId: string) {  console.log('[API Service] getAccounts')  return request(`/api/accounts/${customerId}`, {}, CACHE.ACCOUNTS)}/** * Sync accounts with Tink * No caching, invalidates accounts and transactions cache */export async function syncAccounts(customerId: string) {  console.log('[API Service] syncAccounts')  const result = await request(`/api/accounts/sync/${customerId}`, {    method: 'POST',  }, CACHE.NONE)    // Invalidate accounts and transactions  revalidateTag('accounts')  revalidateTag('transactions')    return result}// ============================================================================// TRANSACTIONS// ============================================================================/** * Get all transactions for a user * Cached for 2 minutes with 'transactions' tag */export async function getTransactions(customerId: string) {  console.log('[API Service] getTransactions')  return request(`/api/transactions/${customerId}`, {}, CACHE.TRANSACTIONS)}/** * Create new transaction * No caching, invalidates transactions cache */export async function createTransaction(customerId: string, data: any) {  console.log('[API Service] createTransaction')  const result = await request(`/api/transactions/${customerId}`, {    method: 'POST',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate transactions cache  revalidateTag('transactions')    return result}/** * Update transaction * No caching, invalidates transactions cache */export async function updateTransaction(transactionId: string, data: any) {  console.log('[API Service] updateTransaction')  const result = await request(`/api/transactions/${transactionId}`, {    method: 'PATCH',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate transactions cache  revalidateTag('transactions')    return result}/** * Delete transaction * No caching, invalidates transactions cache */export async function deleteTransaction(transactionId: string) {  console.log('[API Service] deleteTransaction')  const result = await request(`/api/transactions/${transactionId}`, {    method: 'DELETE',  }, CACHE.NONE)    // Invalidate transactions cache  revalidateTag('transactions')    return result}// ============================================================================// BUDGET// ============================================================================/** * Get budget for a user * Cached for 5 minutes with 'budget' tag */export async function getBudget(customerId: string) {  console.log('[API Service] getBudget')  return request(`/api/budget/${customerId}`, {}, CACHE.BUDGET)}/** * Create or update budget * No caching, invalidates budget cache */export async function updateBudget(customerId: string, data: any) {  console.log('[API Service] updateBudget')  const result = await request(`/api/budget/${customerId}`, {    method: 'POST',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate budget cache  revalidateTag('budget')    return result}// ============================================================================// CATEGORIES// ============================================================================/** * Get all categories * Cached for 10 minutes with 'categories' tag */export async function getCategories(customerId: string) {  console.log('[API Service] getCategories')  return request(`/api/categories/${customerId}`, {}, CACHE.CATEGORIES)}/** * Create custom category * No caching, invalidates categories cache */export async function createCategory(customerId: string, data: any) {  console.log('[API Service] createCategory')  const result = await request(`/api/categories/${customerId}`, {    method: 'POST',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate categories cache  revalidateTag('categories')    return result}/** * Update category * No caching, invalidates categories cache */export async function updateCategory(categoryId: string, data: any) {  console.log('[API Service] updateCategory')  const result = await request(`/api/categories/${categoryId}`, {    method: 'PATCH',    body: JSON.stringify(data),  }, CACHE.NONE)    // Invalidate categories cache  revalidateTag('categories')    return result}/** * Delete category * No caching, invalidates categories cache */export async function deleteCategory(categoryId: string) {  console.log('[API Service] deleteCategory')  const result = await request(`/api/categories/${categoryId}`, {    method: 'DELETE',  }, CACHE.NONE)    // Invalidate categories cache  revalidateTag('categories')    return result}// ============================================================================// ANALYTICS// ============================================================================/** * Get analytics data * No caching (calculated from transactions) */export async function getAnalytics(customerId: string, params?: {  startDate?: string  endDate?: string  groupBy?: 'day' | 'week' | 'month'}) {  console.log('[API Service] getAnalytics')  const queryParams = new URLSearchParams(params as any).toString()  const endpoint = `/api/analytics/${customerId}${queryParams ? `?${queryParams}` : ''}`  return request(endpoint, {}, CACHE.NONE)}// ============================================================================// TINK INTEGRATION// ============================================================================/** * Handle Tink callback * No caching */export async function handleTinkCallback(code: string, credentialsId?: string) {  console.log('[API Service] handleTinkCallback')  const params = new URLSearchParams({ code })  if (credentialsId) params.append('credentialsId', credentialsId)    return request(`/api/callback?${params.toString()}`, {}, CACHE.NONE)}